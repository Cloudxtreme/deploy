--- view_commit.html.orig	2015-10-10 15:26:54.000000000 +0000
+++ view_commit.html	2015-10-10 21:59:16.692135485 +0000
@@ -33,7 +33,7 @@
       and <span class=deletions>{{ summary.ndeletions }} deletion(s)</span>.
     </span>
     <span>
-      <a href="{{ request.path.rstrip('/') }}.diff">Raw diff</a>
+      <a href="{{ url_for('commit', repo=repo.name, rev=rev).rstrip('/') }}.diff">Raw diff</a>
     </span>
     <span>
       <a href=# onclick="toggler.collapseAll('.file'); return false">Collapse all</a>
