#!/bin/sh

OLDJAIL=nginxold
OIP=10.7.7.101
NEWJAIL=nginx
NIP=10.7.7.2

fres

gtfc-overlay-install

iocage stop ${NEWJAIL}

uuid=$( iocage get host_hostuuid ${NEWJAIL} )

iocage set tag=${OLDJAIL} $uuid

iocage set ip4_addr="lo1|${OIP}" $uuid

cp -a /iocage/tags/${OLDJAIL}/fstab /iocage/tags/${OLDJAIL}/fstab.old

cat /iocage/tags/${OLDJAIL}/fstab.old \
    | sed ";/iocage/tags/${NEWJAIL}/;/iocage/tags/${OLDJAIL}/;" \
    >/iocage/tags/${OLDJAIL}/fstab

iocage start ${OLDJAIL}

gtfc-push

cat <<EOF
Waiting for _deploy_jails to finish running via gtfc-push.

You can check on the status with:
    Ctrl + b  s

When it's done, type:
    exit
EOF

sh

nginx-migrate-local ${OLDJAIL}

iocage stop ${NEWJAIL}

iocage start ${NEWJAIL}

iocage destroy -f ${OLDJAIL}
