#!/bin/sh


OLDJAIL=nginxold
ONUM=101
OIP=10.7.7.${ONUM}
NEWJAIL=nginx
NIP=10.7.7.2
 tmppfcfg=/usr/local/etc/deploypfucarp.conf.d.nginxtmp
goodpfcfg=/usr/local/etc/deploypfucarp.conf.d/nginx
goodjailcfg=/usr/local/etc/deployjails.conf.d/015_nginx
oldpfcfg=${goodpfcfg}old
oldjailcfg=${goodjailcfg}old

#fres

#gtfc-overlay-install




## map portfwd to old jail
mv ${goodpfcfg}  ${tmppfcfg}
cat >${oldjailcfg} <<EOF
${ONUM}   nginxold               on
EOF
cat >${oldpfcfg} <<EOF
nginxold           0   80      80      u
nginxold           0   443     443     .
EOF

iocage stop ${NEWJAIL}
uuid=$( iocage get host_hostuuid ${NEWJAIL} )
iocage set tag=${OLDJAIL} $uuid
iocage set ip4_addr="lo1|${OIP}" $uuid

cp -a /iocage/tags/${OLDJAIL}/fstab /iocage/tags/${OLDJAIL}/fstab.old
cat /iocage/tags/${OLDJAIL}/fstab.old \
    | sed "s;/iocage/tags/${NEWJAIL}/;/iocage/tags/${OLDJAIL}/;" \
    >/iocage/tags/${OLDJAIL}/fstab

iocage start ${OLDJAIL}



#gtfc-push
cat >/dev/null <<EOF
Waiting for _deploy_jails to finish running via gtfc-push.

You can check on the status with:
    Ctrl + b  s

When it's done, type:
    exit
EOF
#sh
_deploy_jails

iocage stop ${OLDJAIL}
iocage stop ${NEWJAIL}
nginx-migrate-local ${OLDJAIL}
iocage start ${NEWJAIL}
## map portfwd to new jail
mv ${tmppfcfg}  ${goodpfcfg}
rm ${oldpfcfg}
rm ${oldjailcfg}
_deploy_jails



iocage destroy -f ${OLDJAIL}
