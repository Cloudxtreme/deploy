#!/bin/sh

# READY

if [ "x" == "x${SQUIDPKG}" ]; then
    echo "ERROR: SQUIDPKG not defined."
    exit 1
fi

export BATCH=yes

NEWINSTALL="YES"
if sysrc squid_enable | grep YES >/dev/null ; then
    NEWINSTALL="NO"
    pkg remove -y openssl
fi

if [ "xYES" == "x${NEWINSTALL}" ]; then
    if [ -e ${SQUIDPKG} ]; then
        pkg add -f ${SQUIDPKG}
    else
        PORTNAME="www/squid"
        ## install squid and dependencies
        pkg install -y ${PORTNAME} lang/perl5.20
        ## remove squid because we want custom options
        ## openssl from ports conflicts https://lists.freebsd.org/pipermail/freebsd-questions/2015-June/266245.html
        pkg remove -y ${PORTNAME} openssl
        # psnap

        ## we want LAX_HTTP=on
        if [ ! -e /usr/ports/${PORTNAME}/Makefile.orig ]; then
            cp /usr/ports/${PORTNAME}/Makefile /usr/ports/${PORTNAME}/Makefile.orig
        fi
        cat /usr/ports/${PORTNAME}/Makefile.orig | sed 's;OPTIONS_DEFAULT=;OPTIONS_DEFAULT=LAX_HTTP SSL SSL_CRTD TP_PF LARGEFILE ;' >/usr/ports/${PORTNAME}/Makefile

        ## remove old config
        if [ -e /var/db/ports/www_squid/options ]; then
            rm /var/db/ports/www_squid/options
        fi

        mkdir -p /var/ports/packages/All
        cd /usr/ports/${PORTNAME}
        make && make install && make package \
        && cp /var/ports/usr/ports/${PORTNAME}/work/pkg/*.txz /var/ports/packages/All/ \
        && make clean
        ## see /var/ports/packages/All/
    fi

    if ! which squid ; then
        echo "Failed to build squid."
        exit 1
    fi
fi

install -m 644 ~/git/deploy/usr/local/etc/squid/squid.conf /usr/local/etc/squid/squid.conf

if [ ! -e /usr/local/etc/squid/public.pem ]; then
    yes '' | openssl req -new -newkey rsa:2048 -sha256 -days 365 -nodes -x509 -keyout /usr/local/etc/squid/private.pem -out /usr/local/etc/squid/public.pem
fi
chown squid:squid /usr/local/etc/squid/*.pem
chmod 644 /usr/local/etc/squid/public.pem
chmod 600 /usr/local/etc/squid/private.pem

install -m 644 ~/git/deploy/usr/local/etc/squid/public.pac /usr/local/etc/squid/public.pac

sysrc squid_enable="YES"

if [ "xYES" == "x${NEWINSTALL}" ]; then
    squid -z
    sleep 5
fi

chown -R squid:squid /var/squid

if [ ! -e /var/squid/ssl_db ]; then
    /usr/local/libexec/squid/ssl_crtd -c -s /var/squid/ssl_db -M 4MB
    sleep 5
fi

chown -R squid:squid /var/squid

if [ "xYES" == "x${NEWINSTALL}" ]; then
    service squid start
fi

echo
JAILIP=`ifconfig | grep inet | awk '{print $2}'`
echo "Squid is setup, eza-unlink-basejail will setup PKG_ENV to ${JAILIP}:3128"

# 3127 for public.pem
deploy nginx
cat ~/git/deploy/usr/local/etc/nginx/sites-available/squid \
    | sed "s/0.0.0.0/${JAILIP}/" \
    >/usr/local/etc/nginx/sites-enabled/squid
chmod 644 /usr/local/etc/nginx/sites-enabled/squid
