#!/bin/sh

# READY

######################################################################
# Script version is yymmdd-HHMMSS in UTC, date -u +%y%m%d-%H%M%S
######################################################################
SCRIPTVERSION=151008-042422

SQUIDPKG=/var/ports/packages/All/squid-3.5.9_1.txz

export BATCH=yes

NEWINSTALL="YES"
if sysrc squid_enable | grep YES >/dev/null ; then
    NEWINSTALL="NO"
    pkg remove -y openssl
fi

if [ "xYES" == "x${NEWINSTALL}" ]; then
    if [ -e ${SQUIDPKG} ]; then
        pkg add -f ${SQUIDPKG}
    else
        PORTNAME="www/squid"
        # install squid and dependencies
        pkg install -y ${PORTNAME} lang/perl5.20
        # remove squid because we want custom options
        # openssl from ports conflicts https://lists.freebsd.org/pipermail/freebsd-questions/2015-June/266245.html
        pkg remove -y ${PORTNAME} openssl
        # use portsnap, but portsnap doesn't like non-interactive so we need a human to help
        psnap

        # we want LAX_HTTP=on
        if [ ! -e /usr/ports/${PORTNAME}/Makefile.orig ]; then
            cp /usr/ports/${PORTNAME}/Makefile /usr/ports/${PORTNAME}/Makefile.orig
        fi
        cat /usr/ports/${PORTNAME}/Makefile.orig | sed 's;OPTIONS_DEFAULT=;OPTIONS_DEFAULT=LAX_HTTP SSL SSL_CRTD TP_PF LARGEFILE ;' >/usr/ports/${PORTNAME}/Makefile

        # remove old config
        if [ -e /var/db/ports/www_squid/options ]; then
            rm /var/db/ports/www_squid/options
        fi

        cd /usr/ports/${PORTNAME}
        make && make install && make package && make clean
    fi

    if ! which squid ; then
        echo "Failed to build squid."
        exit 1
    fi
fi

install -m 644 /root/git/deploy/usr/local/etc/squid/squid.conf /usr/local/etc/squid/squid.conf

if [ ! -e /usr/local/etc/squid/public.pem ]; then
    yes '' | openssl req -new -newkey rsa:2048 -sha256 -days 365 -nodes -x509 -keyout /usr/local/etc/squid/private.pem -out /usr/local/etc/squid/public.pem
fi
chown squid:squid /usr/local/etc/squid/*.pem
chmod 644 /usr/local/etc/squid/public.pem
chmod 600 /usr/local/etc/squid/private.pem

install -m 644 /root/git/deploy/usr/local/etc/squid/public.pac /usr/local/etc/squid/public.pac

sysrc squid_enable="YES"

if [ "xYES" == "x${NEWINSTALL}" ]; then
    squid -z
    sleep 5
fi

chown -R squid:squid /var/squid

if [ ! -e /var/squid/ssl_db ]; then
    /usr/local/libexec/squid/ssl_crtd -c -s /var/squid/ssl_db -M 4MB
    sleep 5
fi

chown -R squid:squid /var/squid

if [ "xYES" == "x${NEWINSTALL}" ]; then
    service squid start
fi

echo
JAILIP=`ifconfig | grep inet | awk '{print $2}'`
echo "Squid is setup, eza-unlink-basejail will setup PKG_ENV to ${JAILIP}:3128"
