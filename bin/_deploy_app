#!/bin/sh

. /usr/local/bin/loadmyvars.sh

IP=$1
name=$2
boot=$3
deployapp=$4
fstab=/iocage/tags/${name}/fstab

setupnginxconfig() {
    local newcfg=${1}
    local oldcfg=${2}
    local FQDN=${3}
    local path=$( ioc-pathof nginx )/usr/local/etc/nginx/sites-enabled/${newcfg}
    if [ ! -e ${path} ]; then
        cat ~/git/deploy/usr/local/etc/nginx/sites-available/${oldcfg} \
            | sed "s/localhost.localdomain/${FQDN}/" \
            >${path}
    fi
    chmod 644 $path
}

fstab_readonly() {
    local name=$1
    local fstab=$2
        install -d /iocage/tags/${name}/root/var/ports
    if [ -e ${fstab} ]; then
        cat >${fstab} <<EOF
/var/ports                      /iocage/tags/${name}/root/var/ports             nullfs    ro    0    0
EOF
    fi

}

fstab_write() {
    local name=$1
    local fstab=$2
        install -d /iocage/tags/${name}/root/usr/ports
        install -d /iocage/tags/${name}/root/var/ports
    if [ -e ${fstab} ]; then
        cat >${fstab} <<EOF
/usr/ports                      /iocage/tags/${name}/root/usr/ports             nullfs    rw    0    0
/var/ports                      /iocage/tags/${name}/root/var/ports             nullfs    rw    0    0
EOF
    fi

}

if [ "x" = "x${NIC}" ]; then
    NIC="lo1"
    if ! ifconfig ${NIC} >/dev/null ; then
        ifconfig ${NIC} create
    fi
fi

if ! iocage list -r | grep 'RELEASE' >/dev/null 2>/dev/null ; then
    ioc-setup
    if ! iocage list -r | grep 'RELEASE' >/dev/null 2>/dev/null ; then
        echo "ERROR: iocage release doesn't exist, something went wrong."
        exit 1
    fi
fi

if ! iocage get tag ${name} >/dev/null 2>/dev/null; then
    # typically only in here if deploying a single app not with _deploy_jails, eg.
    # env NIC=lo1 IP=10.7.7.7
    if [ "x" = "x$IP" ]; then
        echo "Usage: ${0##*/} name 10.7.7.253 boot_on/off app_name"
        exit 1
    fi
    echo "Creating: ${name} on ${NIC} w/ IP $IP"
    ioc-newjail ${name} "${NIC}|${IP}"
fi
if [ "x" = "x${boot}" ]; then
    boot=off
fi
if [ "x" = "x${deployapp}" ]; then
    deployapp=${name}
fi

sysrc -f $( ioc-pathof ${name} )/etc/rc.conf.d/firstboot_jail firstboot_jail_deploy=${deployapp}


### install some deploy_* scripts for firstboot
install -d -m 755 -o root -g wheel $( ioc-pathof ${name} )/usr/local/bin
for i in $( ls /usr/local/bin/deploy_* ) ; do
    install -C -m 755 $i $( ioc-pathof ${name} )/usr/local/bin/
done


# PRE START
case ${name} in
    builder|buildersquidpkg|builderffmpegpkg|buildergitlabpkg|builderbansheepkg|builderampachepkg|builderi2ppkg)
        fstab_write ${name} ${fstab}
    ;;
    squid)
        fstab_readonly ${name} ${fstab}
    ;;
    gitlab)
        iocage set allow_sysvipc=1 ${name}
        fstab_readonly ${name} ${fstab}
        ## only if we are installing via src to cache rubygems
        deploy_squid_sslcert_fetch ${name}
        # Set jail ip as FQDN so git-shell works
        grep -v " ${FQDN}" $( ioc-pathof ${name} )/etc/hosts >$( ioc-pathof ${name} )/etc/hosts.tmp
        cat $( ioc-pathof ${name} )/etc/hosts.tmp >$( ioc-pathof ${name} )/etc/hosts
        echo "${IPNET}`jailip gitlab` ${FQDN}" >>$( ioc-pathof ${name} )/etc/hosts
    ;;
    owncloud)
        iocage set allow_sysvipc=1 ${name}
        #if [         -d /root/local/owncloud ]; then
        #    mkdir -p                          $( ioc-pathof ${name} )/root/local/owncloud
        #    rsync -qalmP /root/local/owncloud/ $( ioc-pathof ${name} )/root/local/owncloud/
        #fi
    ;;
    horde)
        iocage set allow_sysvipc=1 ${name}
    ;;
    zfssyncstatus)
            install -d /usr/local/www/data
            install -d /iocage/tags/${name}/root/usr/local/www/data
            install -d /iocage/tags/${name}/root/var/hostlog
        if [ -e ${fstab} ]; then
            cat >${fstab} <<EOF
/usr/local/www/data    /iocage/tags/${name}/root/usr/local/www/data    nullfs    ro    0    0
/var/log               /iocage/tags/${name}/root/var/hostlog           nullfs    ro    0    0
EOF
        fi
    ;;
    ampache)
            install -d ${PERSONALMNT}/audio
            install -d ${PERSONALMNT}/video
            install -d /iocage/tags/${name}/root/data/audio
            install -d /iocage/tags/${name}/root/data/video
        fstab_readonly ${name} ${fstab}
        if [ -e ${fstab} ]; then
            cat >>${fstab} <<EOF
${PERSONALMNT}/audio            /iocage/tags/${name}/root/data/audio            nullfs    ro    0    0
${PERSONALMNT}/video            /iocage/tags/${name}/root/data/video            nullfs    ro    0    0
EOF
        fi
    ;;
esac



iocage start ${name}
iocage set boot=${boot} ${name}



# AFTER START
case ${name} in
    nginx)
        setupnginxconfig domain   nginx-all ${FQDN}
        setupnginxconfig nodomain nodomain  ${FQDN}
        iocage stop ${name}
        iocage start ${name}
    ;;
    owncloud)
        #rsync -qalmP $( ioc-pathof ${name} )/root/local/owncloud/ /root/local/owncloud/
    ;;
esac
