#!/bin/sh

# READY

######################################################################
# Script version is yymmdd-HHMMSS in UTC, date -u +%y%m%d-%H%M%S
######################################################################
SCRIPTVERSION=150627-054607

if [ "x" == "x${FQDN}" ]; then
    echo "Please set or export variable FQDN"
    exit 1
fi

if [ "x" == "x${SQUID}" ]; then
    echo "Please set or export variable SQUID to a LAN IP. Default is 10.7.7.1:3128"
    exit 1
fi

if [ "x" == "x${REPOSRC}" ]; then
    REPOSRC=https://github.com/
fi

if [ "x" == "x${GITLABSRC}" ]; then
    GITLABSRC=https://gitlab.com/
fi

if [ "x" == "x${NIC}" ]; then
    NIC="lo1"
    if ! ifconfig ${NIC} >/dev/null ; then
        ifconfig ${NIC} create
    fi
fi

if [ "x" == "x${IPNET}" ]; then
    IPNET="10.7.7."
fi

if [ "x" == "x${HOSTIP}" ]; then
    HOSTIP=`ifconfig | grep -v 0xffffffff | grep -v 127.0.0.1 | egrep -o 'inet *([0-9]{1,3}\.){1,3}[0-9]{1,3}' | awk '{print $2}'`
fi

if [ "x" == "x${HOSTNIC}" ]; then
    HOSTNIC=`netstat -nr | grep default | awk '{print $NF}'`
fi

if ! zfs list tank >/dev/null ; then
    fzg -i -D
fi

if ! zfs list tank/ezjail >/dev/null ; then
    eza install -h file:///boot/../10.1-RELEASE
    eza-update
fi

if [ "x" == "x${STARTCOUNT}" ]; then
    # remove anything that's not a digit
    count=`echo ${STARTCOUNT} | sed 's/[^[:digit:]]//g'`
fi

if [ "x" == "x${count}" ]; then
    count=0
fi

GOOD="
     1  squid
     2  nginx
     3  couch
     4  dtfc
     5  piwik
     6  owncloud
     7  ejabberd
     8  murmur
     9  vnc
    10  gitlab
"

DEV="
    11  monit
    12  zabbix
    13  minidlna
    14  firefly
    15  echoplexus
    16  gitannex
    17  gogs
    18  phabricator
    19  pydio
"

BAD="
    30  baikal
    31  couchdtfc
    32  horde
"



setuppf() {
    cat >/etc/pf/jails.anchor <<EOF
    nat pass on ${HOSTNIC} inet from ${IPNET}0/24 to any -> ${HOSTIP}
    rdr pass on ${HOSTNIC} inet proto tcp from any to ${HOSTIP} port = 3127 -> ${IPNET}`jailip squid`
    rdr pass on ${HOSTNIC} inet proto tcp from any to ${HOSTIP} port = 3128 -> ${IPNET}`jailip squid`
    rdr pass on ${HOSTNIC} inet proto tcp from any to ${HOSTIP} port = 80 -> ${IPNET}`jailip nginx`
    rdr pass on ${HOSTNIC} inet proto tcp from any to ${HOSTIP} port = 443 -> ${IPNET}`jailip nginx`
    rdr pass on ${HOSTNIC} inet proto tcp from any to ${HOSTIP} port = 5222 -> ${IPNET}`jailip ejabberd`
    rdr pass on ${HOSTNIC} inet proto tcp from any to ${HOSTIP} port = 64738 -> ${IPNET}`jailip murmur`
    rdr pass on ${HOSTNIC} inet proto tcp from any to ${HOSTIP} port = 23 -> ${IPNET}`jailip gitlab`
EOF
    if [ "x" != "x${SQUIDIPALIAS}" ]; then
        # if we have a squid IP alias from HOSTNIC
        cat >>/etc/pf/jails.anchor <<EOF
    rdr pass on ${HOSTNIC} inet proto tcp from any to ${SQUIDIPALIAS} port = 3127 -> ${IPNET}`jailip squid`
    rdr pass on ${HOSTNIC} inet proto tcp from any to ${SQUIDIPALIAS} port = 3128 -> ${IPNET}`jailip squid`
EOF
        if [ ! -e /etc/rc.conf.d/ucarp ]; then
            cat >>/etc/rc.conf.d/ucarp <<EOF
    # primary   ucarp_preempt="YES"
    # primary   ucarp_advskew="100"
    # secondary ucarp_advskew="200"
    # ucarp_enable="YES"
    # ucarp_pass=""
    # ucarp_passfile="/usr/local/etc/ucarppass"
    ucarp_addr="${SQUIDIPALIAS}"
    ucarp_if="${HOSTNIC}"
    ucarp_src="${HOSTIP}"
EOF
        fi
    cat <<EOF
    You may want to:
        vi /etc/rc.conf.d/ucarp
        service ucarp start
EOF
    fi
    if [ "x" != "x${WEBIPALIAS}" ]; then
        # if we have a web IP alias from HOSTNIC
        cat >>/etc/pf/jails.anchor <<EOF
    rdr pass on ${HOSTNIC} inet proto tcp from any to ${WEBIPALIAS} port = 80 -> ${IPNET}`jailip nginx`
    rdr pass on ${HOSTNIC} inet proto tcp from any to ${WEBIPALIAS} port = 443 -> ${IPNET}`jailip nginx`
    rdr pass on ${HOSTNIC} inet proto tcp from any to ${WEBIPALIAS} port = 23 -> ${IPNET}`jailip gitlab`
EOF
        cat /usr/local/etc/rc.d/ucarp | sed 's;ucarp;ucarw;' | sed 's;/usr/local/sbin/ucarw;/usr/local/sbin/ucarp;' >/usr/local/etc/rc.d/ucarw
        chmod 755 /usr/local/etc/rc.d/ucarw
        if [ ! -e /etc/rc.conf.d/ucarw ]; then
            cat >>/etc/rc.conf.d/ucarw <<EOF
    # primary   ucarw_preempt="YES"
    # primary   ucarw_advskew="100"
    # secondary ucarw_advskew="200"
    # ucarw_enable="YES"
    # ucarw_pass=""
    # ucarw_passfile="/usr/local/etc/ucarwpass"
    ucarw_addr="${WEBIPALIAS}"
    ucarw_if="${HOSTNIC}"
    ucarw_src="${HOSTIP}"
EOF
        fi
    cat <<EOF
    You may want to:
        vi /etc/rc.conf.d/ucarw
        service ucarw start
EOF
    fi
    pf-anchor clear jails
    pf-anchor load jails
}

jailip() {
    # omit ${BAD}
    JAILDATASET="${GOOD} ${DEV} ${BAD}"
    addtocount=""
    echo "$JAILDATASET" \
        | while read num name ; do
            if [ "${1}" == "${name}" ]; then
                addtocount=${num}
            fi
        done
    if [ "x" != "x${addtocount}" ]; then
        echo $(( count + addtocount ))
    else
        echo 0
    fi
}

setupnginxconfig() {
    local i=${1}
    local FQDN=${2}
    couchdatabases="movies music wiki"
    gitlabpaths="admin assets dashboard explore groups help profile projects s snippets u users"
    tlsconf="/usr/local/etc/nginx/tls.conf"
    proxypass="/usr/local/etc/nginx/proxypass.conf"
    cat >/usr/jails/${i}/usr/local/etc/nginx/sites-enabled/${i} <<EOF
        client_max_body_size 0;
        upstream couchsources {
            server ${IPNET}`jailip couch`:5984;
        }
        upstream dtfcsources {
            server ${IPNET}`jailip dtfc`:8080;
        }
        upstream owncloudsources {
            server ${IPNET}`jailip owncloud`:443;
        }
        upstream gitlabsources {
            server ${IPNET}`jailip gitlab`:8080;
        }
        map \$uri \$redirect_uri {
            ~^/owncloud\$ https://${FQDN}/owncloud/;
            ~^/couch\$    https://${FQDN}/couch/;
EOF
        for c in ${couchdatabases} ; do
            cat >>/usr/jails/${i}/usr/local/etc/nginx/sites-enabled/${i} <<EOF
            ~^/${c}\$   https://${FQDN}/${c}/;
EOF
        done
        cat >>/usr/jails/${i}/usr/local/etc/nginx/sites-enabled/${i} <<EOF
            ~^/\$         https://${FQDN}/explore;
        }
        server {
            listen   ${IPNET}`jailip nginx`:80 default_server;
            server_name ${FQDN};
            server_name ${IPNET}`jailip nginx`;
            return 302 https://$host$request_uri;
        }
        server {
            listen 443 ssl;
            server_name ${FQDN};
            ssl_certificate ssl/ssl.crt;
            ssl_certificate_key ssl/ssl.key;
            include ${tlsconf};
            location ~^/(_session|_replicate|_users) {
                rewrite  /(.*) /\$1 break;
                include ${proxypass};
                proxy_pass http://couchsources;
            }
            location ~^/couch/ {
                rewrite  /couch/(.*) /\$1 break;
                include ${proxypass};
                proxy_pass http://couchsources;
            }
            location  ~^/dtfc/ {
                rewrite /dtfc/(.*) /\$1 break;
                include ${proxypass};
                proxy_pass http://dtfcsources;
            }
            location  ~^/owncloud/ {
                rewrite /owncloud/(.*) /owncloud/\$1 break;
                include ${proxypass};
                proxy_pass https://owncloudsources;
            }
            location / {
                try_files \$uri \$uri/ @redirect-map;
            }
            location @redirect-map {
                if (\$redirect_uri) {
                    return 302 \$redirect_uri;
                }
            }
EOF
            for c in ${couchdatabases} ; do
                cat >>/usr/jails/${i}/usr/local/etc/nginx/sites-enabled/${i} <<EOF
            location  ~^/${c}/ {
                rewrite /${c}/(.*) /${c}/_design/${c}/_rewrite/\$1 break;
                include ${proxypass};
                proxy_pass http://couchsources;
            }
EOF
            done
            for g in ${gitlabpaths} ; do
                cat >>/usr/jails/${i}/usr/local/etc/nginx/sites-enabled/${i} <<EOF
            location  ~^/${g}/ {
                rewrite /${g}/(.*) /${g}/\$1 break;
                include ${proxypass};
                proxy_pass http://gitlabsources;
            }
            location  ~^/${g}\$ {
                rewrite /${g} /${g} break;
                include ${proxypass};
                proxy_pass http://gitlabsources;
            }
EOF
            done
            cat >>/usr/jails/${i}/usr/local/etc/nginx/sites-enabled/${i} <<EOF
            #letfover slashes or more to gitlab
            location  ~^/(.*)/(.*) {
                rewrite /(.*)/(.*) /\$1/\$2 break;
                include ${proxypass};
                proxy_pass http://gitlabsources;
            }
        }
EOF
}

case ${1} in
    good)
        JAILNAMES="${GOOD}"
        ;;
    bad)
        JAILNAMES="${BAD}"
        ;;
    dev)
        JAILNAMES="${DEV}"
        ;;
    nginx)
        setuppf
        setupnginxconfig nginx ${FQDN}
        exit
        ;;
    *)
        echo "ERROR: $0 [good|bad|dev|nginx]"
        exit 1
        ;;
esac

allowsysvipc() {
    if ! grep 'allow.sysvipc=1' /usr/local/etc/ezjail/${1} >/dev/null ; then
        echo "export jail_${1}_parameters=\"allow.sysvipc=1\"" >>/usr/local/etc/ezjail/${1}
    fi
}

copysslselfcert() {
    if [ "x" != "x${SQUIDIPALIAS}" ]; then
        if ifconfig | grep ${SQUIDIPALIAS} >/dev/null ; then
            cat /usr/jails/squid/usr/local/etc/squid/public.pem >>/usr/jails/${1}/usr/local/share/certs/ca-root-nss.crt
        else
            fetch -o /usr/jails/${1}/root/public-${SQUIDIPALIAS}.pem http://${SQUIDIPALIAS}:3127/public.pem
            cat      /usr/jails/${1}/root/public-${SQUIDIPALIAS}.pem >>/usr/jails/${1}/usr/local/share/certs/ca-root-nss.crt
        fi
    else
        cat /usr/jails/squid/usr/local/etc/squid/public.pem >>/usr/jails/${1}/usr/local/share/certs/ca-root-nss.crt
    fi
}



setuppf

echo "$JAILNAMES" \
    | while read num i ; do
    if [ ! -e /usr/jails/${i} ]; then
        eza create ${i}        "${NIC}|${IPNET}${num}"
        env SQUID=${SQUID} REPOSRC=${REPOSRC} eza-unlink-basejail ${i}
        eza stop ${i}
        zfs snap tank/ezjail/${i}@10.1-RELEASE-p12
    else
        eza console -f -e "env REPOSRC=${REPOSRC} fres" ${i}
        if [ "squid" != "${i}" ]; then
            eza console -f -e "pkg update" ${i}
            eza console -f -e "pkg upgrade -y" ${i}
        fi
    fi
    # The following case can be in any order
    case ${i} in
        # GOOD JAILNAMES
        squid)
            # based on https://forums.freebsd.org/threads/transparent-proxy-in-jail-with-pf-in-host.42075/
            cat >>/etc/devfs.rules <<EOF
[devfsrules_jail=4]
add include \$devfsrules_hide_all
add include \$devfsrules_unhide_basic
add include \$devfsrules_unhide_login
add path zfs unhide
add path pf unhide mode 0640 group 100
EOF
            if [ -e /var/ports ]; then
                rsync -viaP --exclude work /var/ports/ /usr/jails/${i}/var/ports/
            fi
            eza console -f -e "deploy ${i}" ${i}
            rsync -viaP --exclude work /usr/jails/${i}/var/ports/ /var/ports/
            # easydns-client here to reduce risk of lost/rollbacked config
            eza console -f -e "deploy easydnsclient" ${i}
            # 3127 for public.pem
            cat >/usr/jails/${i}/usr/local/etc/nginx/sites-enabled/${i} <<EOF
                server {
                    listen   ${IPNET}`jailip squid`:3127 default_server;
                    server_name ${IPNET}`jailip squid`;
                    location =/public.pem {
                        alias /usr/local/etc/squid/public.pem;
                    }
                    location =/public.pac {
                        alias /usr/local/etc/squid/public.pac;
                    }
                }
EOF
            eza console -f -e "deploy nginx" ${i}
            eza console -f -e sh ${i} <<EOF
su urep -c "/bin/mkdir -p /usr/home/urep/bin"
cp -a /root/bin/fres /usr/home/urep/bin/fres
chown urep /usr/home/urep/bin/fres
su urep -c "/usr/home/urep/bin/fres"
su urep -c "/usr/home/urep/bin/deploy easydnsclient"
EOF
            ;;
        nginx)
            setupnginxconfig ${i} ${FQDN}
            eza console -f -e "deploy ${i}" ${i}
            ;;
        couch)
            eza console -f -e "env FQDN=${FQDN} deploy ${i}db" ${i}
            ;;
        owncloud)
            allowsysvipc ${i}
            eza console -f -e "env FQDN=${FQDN} deploy ${i}" ${i}
            ;;
        dtfc)
            eza console -f -e "env FQDN=${FQDN} REPOSRC=${REPOSRC} deploy ${i}" ${i}
            ;;
        ejabberd)
            eza console -f -e "env FQDN=${FQDN} deploy ${i}" ${i}
            ;;
        murmur)
            eza console -f -e "deploy ${i}" ${i}
            ;;
        vnc)
            eza console -f -e "deploy ${i}" ${i}
            ;;
        gitlab)
            allowsysvipc ${i}
            copysslselfcert ${i}
            eza console -f -e "env FQDN=${FQDN} GITLABSRC=${GITLABSRC} HTTP_PROXY=http://${SQUID} deploy ${i}_src" ${i}
            ;;
        # BAD JAILNAMES
        baikal)
            eza console -f -e "env FQDN=${FQDN} deploy ${i}" ${i}
            ;;
        couchdtfc)
            eza console -f -e "env FQDN=${FQDN} REPOSRC=${REPOSRC} deploy couchdbdtfc" ${i}
            ;;
        horde)
            allowsysvipc ${i}
            eza console -f -e "env FQDN=${FQDN} deploy ${i}webmail" ${i}
            ;;
        # DEV JAILNAMES
        echoplexus)
            eza console -f -e "env REPOSRC=${REPOSRC} deploy ${i}" ${i}
            ;;
        gitannex)
            eza console -f -e "deploy ${i}" ${i}
            ;;
        gogs)
            eza console -f -e "deploy ${i}_src" ${i}
            ;;
        phabricator)
            eza console -f -e "deploy ${i}" ${i}
            ;;
        pydio)
            eza console -f -e "deploy ${i}" ${i}
            ;;
    esac
    if [ "xsquid" != "x${i}" ]; then
        eza stop ${i}
    fi
done
