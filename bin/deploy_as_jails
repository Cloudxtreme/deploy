#!/bin/sh

# READY

######################################################################
# Script version is yymmdd-HHMMSS in UTC, date -u +%y%m%d-%H%M%S
######################################################################
SCRIPTVERSION=150618-191720

if [ "x" == "x${FQDN}" ]; then
    echo "Please set or export variable FQDN"
    exit 1
fi

if [ "x" == "x${NIC}" ]; then
    NIC="lo1"
    REALNIC=`netstat -nr | grep default | awk '{print $NF}'`
fi

if [ "x" == "x${IPNET}" ]; then
    IPNET="10.7.7."
fi

GOOD="
proxy
couch
owncloud
dtfc
ejabberd
murmur
vnc
gitlab
"

BAD="
baikal
couchdtfc
horde
"

DEV="
echoplexus
gitannex
gogs
phabricator
pydio
"

case ${1} in
    good)
        JAILNAMES="${GOOD}"
        ;;
    bad)
        JAILNAMES="${BAD}"
        ;;
    dev)
        JAILNAMES="${DEV}"
        ;;
    *)
        echo "ERROR: $0 [good|bad|dev]"
        exit 1
        ;;
esac

allowsysvipc() {
    echo "export jail_${1}_parameters=\"allow.sysvipc=1\"" >>/usr/local/etc/ezjail/${1}
}

count=0
for i in ${JAILNAMES} ; do
    count=$((count+1))
    if [ ! -e /usr/jails/${i} ]; then
        eza create ${i}        "${NIC}|${IPNET}${count}"
        eza-unlink-basejail ${i}
        eza stop ${i}
        zfs snap tank/ezjail/${i}@10.1-RELEASE-p12
    else
        eza console -f -e "fres" ${i}
        eza console -f -e "pkg update" ${i}
        eza console -f -e "pkg upgrade -y" ${i}
    fi
    # The following case can be in any order
    case ${i} in
        # GOOD JAILNAMES
        proxy)
            eza console -f -e "deploy nginx" ${i}
            ;;
        couch)
            eza console -f -e "env FQDN=${FQDN} deploy ${i}db" ${i}
            ;;
        owncloud)
            allowsysvipc ${i}
            eza console -f -e "env FQDN=${FQDN} deploy ${i}" ${i}
            ;;
        dtfc)
            eza console -f -e "env FQDN=${FQDN} deploy ${i}" ${i}
            ;;
        ejabberd)
            eza console -f -e "env FQDN=${FQDN} deploy ${i}" ${i}
            ;;
        murmur)
            eza console -f -e "deploy ${i}" ${i}
            ;;
        vnc)
            eza console -f -e "deploy ${i}" ${i}
            ;;
        gitlab)
            allowsysvipc ${i}
            eza console -f -e "env FQDN=${FQDN} deploy ${i}_src" ${i}
            ;;
        # BAD JAILNAMES
        baikal)
            eza console -f -e "env FQDN=${FQDN} deploy ${i}" ${i}
            ;;
        couchdtfc)
            eza console -f -e "env FQDN=${FQDN} deploy couchdbdtfc" ${i}
            ;;
        horde)
            allowsysvipc ${i}
            eza console -f -e "env FQDN=${FQDN} deploy ${i}webmail" ${i}
            ;;
        # DEV JAILNAMES
        echoplexus)
            eza console -f -e "deploy ${i}" ${i}
            ;;
        gitannex)
            eza console -f -e "deploy ${i}" ${i}
            ;;
        gogs)
            eza console -f -e "deploy ${i}_src" ${i}
            ;;
        phabricator)
            eza console -f -e "deploy ${i}" ${i}
            ;;
        pydio)
            eza console -f -e "deploy ${i}" ${i}
            ;;
    esac
    eza stop ${i}
done
