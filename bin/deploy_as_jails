#!/bin/sh

# READY

######################################################################
# Script version is yymmdd-HHMMSS in UTC, date -u +%y%m%d-%H%M%S
######################################################################
SCRIPTVERSION=150618-015952

FQDN="johnko.ca"
NIC="lo1"
REALNIC=`netstat -nr | grep default | awk '{print $NF}'`
IPNET="10.7.7."
count=0
JAILNAMES="
proxy
couch
owncloud
dtfc
ejabberd
murmur
vnc
gitlab
"

allowsysvipc() {
    echo "export jail_${1}_parameters=\"allow.sysvipc=1\"" >>/usr/local/etc/ezjail/${1}
}

for i in ${JAILNAMES} ; do
    count=$((count+1))
    if [ ! -e /usr/jails/${i} ]; then
        eza create ${i}        "${NIC}|${IPNET}${count}"
        eza-unlink-basejail ${i}
        eza stop ${i}
        zfs snap tank/ezjail/${i}@10.1-RELEASE-p12
    else
        eza console -f -e "fres" ${i}
    fi
    case ${i} in
        proxy)
            eza console -f -e "deploy nginx" ${i}
            ;;
        couch)
            eza console -f -e "env FQDN=${FQDN} deploy ${i}db" ${i}
            ;;
        owncloud)
            allowsysvipc ${i}
            eza console -f -e "env FQDN=${FQDN} deploy ${i}" ${i}
            ;;
        dtfc)
            eza console -f -e "env FQDN=${FQDN} deploy ${i}" ${i}
            ;;
        ejabberd)
            eza console -f -e "deploy ${i}" ${i}
            ;;
        murmur)
            eza console -f -e "deploy ${i}" ${i}
            ;;
        vnc)
            eza console -f -e "deploy ${i}" ${i}
            ;;
        gitlab)
            allowsysvipc ${i}
            eza console -f -e "env FQDN=${FQDN} deploy ${i}_src" ${i}
            ;;
    esac
    eza stop ${i}
done
