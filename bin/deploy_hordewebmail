#!/bin/sh

# READY

######################################################################
# Script version is yymmdd-HHMMSS in UTC, date -u +%y%m%d-%H%M%S
######################################################################
SCRIPTVERSION=150610-070500

if sysctl -a | grep security.jail.sysvipc_allowed >/dev/null ; then
    if sysctl security.jail.sysvipc_allowed | grep 0 >/dev/null ; then
        echo "This jail is not configured to allow sysvipc."
        echo "you need to add jail_example_parameters=\"allow.sysvipc=1\""
        exit 1
    fi
fi

if [ "x" == "x$FQDN" ]; then
    echo "Please set or export variable FQDN"
    exit 1
fi

pkg install -y horde-webmail \
lang/php56 \
php56-ctype \
php56-fileinfo \
php56-pdo \
php56-pdo_pgsql \
php56-pgsql \
php56-tidy \
pecl-geoip \
pecl-imagick \
pecl-pam \
postgresql93-server \
nginx

nginx-config-sites-enabled
cat /usr/local/etc/nginx/sites-available/example-horde | sed "s/localhost.my.domain/${FQDN}/" >/usr/local/etc/nginx/sites-enabled/horde

if [ ! -e /usr/local/www/horde/config/conf.php ]; then
    cp -a /usr/local/www/horde/config/conf.php.dist /usr/local/www/horde/config/conf.php
    chmod 666 /usr/local/www/horde/config/conf.php
fi

HORDEAPPS="turba trean kronolith gollem ingo imp mnemo nag"

for i in ${HORDEAPPS} ; do
    if [ ! -e /usr/local/www/horde/${i}/config/conf.php ]; then
        touch /usr/local/www/horde/${i}/config/conf.php
        chmod 666 /usr/local/www/horde/${i}/config/conf.php
    fi
done

sysrc nginx_enable="YES"
sysrc php_fpm_enable="YES"
sysrc postgresql_enable="YES"

service php-fpm start
service nginx start

service postgresql initdb
service postgresql start

/usr/local/bin/createuser -U pgsql horde
/usr/local/bin/createdb -E utf8 -U pgsql -O horde horde
/usr/local/bin/psql -U pgsql -d template1 -c "ALTER ROLE horde WITH password 'password';"

if [ ! -e /usr/local/pgsql/data/pg_hba.conf.dist ]; then
    cp -a /usr/local/pgsql/data/pg_hba.conf /usr/local/pgsql/data/pg_hba.conf.dist
fi

cat >/usr/local/pgsql/data/pg_hba.conf <<EOF
local   all             all                                     trust
host    all             all             127.0.0.1/32            trust
host    all             all             ::1/128                 trust
hostnossl  horde        horde           samehost                trust
EOF

service postgresql restart

echo
echo "Visit https://${FQDN}/horde/ or https://${FQDN}/horde/test.php"
echo "- setup Preferences to PHP Sessions"
echo "- setup Database to PostgreSQL with sql://horde:password@localhost/horde"
echo "- click Generate Horde Configuration"
echo "- chmod 644 /usr/local/www/horde/config/conf.php"
echo "- click Update All DB Schemas"
for i in ${HORDEAPPS} ; do
    echo "- beside ${i}, click Regenerate configuration"
    echo "- chmod 644 /usr/local/www/horde/${i}/config/conf.php"
done
