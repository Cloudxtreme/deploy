#!/bin/sh

# exit if running already
THISSCRIPT=${0##*/}
if pgrep -lf ${THISSCRIPT} > /dev/null 2> /dev/null ; then
    exit 1
fi


. /usr/local/bin/loadmyvars.sh

if sysctl security.jail.jailed | grep 1 >/dev/null 2>&1; then
    echo "ERROR: Cannot run in a jail"
    exit 1
fi

if [ "x" = "x${FQDN}" ]; then
    echo "Please set or export variable FQDN"
    exit 1
fi

if [ "x" = "x${NIC}" ]; then
    NIC="lo1"
    if ! ifconfig ${NIC} >/dev/null ; then
        ifconfig ${NIC} create
    fi
fi

if [ "x" = "x${IPNET}" ]; then
    IPNET="10.7.7."
fi

if [ "x" = "x${HOSTNIC}" ]; then
    HOSTNIC="$( net-nic )"
fi

if [ "x" = "x${HOSTIP}" ]; then
    HOSTIP="$( net-ip $HOSTNIC )"
fi

if ! iocage list -r | grep 'RELEASE' >/dev/null 2>/dev/null ; then
    ioc-setup
    if ! iocage list -r | grep 'RELEASE' >/dev/null 2>/dev/null ; then
        echo "ERROR: iocage release doesn't exist, something went wrong."
        exit 1
    fi
fi

if [ "x" != "x${STARTCOUNT}" ]; then
    # remove anything that's not a digit
    count=`echo ${STARTCOUNT} | sed 's/[^[:digit:]]//g'`
fi

if [ "x" = "x${count}" ]; then
    count=0
fi


env IPNET="${IPNET}" HOSTIP="${HOSTIP}" HOSTNIC="${HOSTNIC}" _deploy_pf_ucarp


if ls /usr/local/etc/deployjails.conf.d/* >/dev/null 2>&1 ; then
    cat /usr/local/etc/deployjails.conf.d/* \
    | while read num name boot ; do
        case "$num" in "#"*|"") continue; esac
        if [ "x" != "x${num}" ] && [ "x" != "x${name}" ]; then
            if ! iocage get tag ${name} >/dev/null 2>/dev/null; then
                # The following case can be in any order
                case ${name} in
                    smtp)                       _deploy_app ${IPNET}${num} ${name} ${boot} postfix ;;
                    gitlab)                     _deploy_app ${IPNET}${num} ${name} ${boot} ${name}_config ;;
                    gogs)                       _deploy_app ${IPNET}${num} ${name} ${boot} ${name}_src ;;
                    horde)                      _deploy_app ${IPNET}${num} ${name} ${boot} ${name}webmail ;;
                    *)                          _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                esac
                #if [ "xsquid" != "x${name}" ]; then
                #    iocage stop ${name}
                #fi
            fi # end of if not jail exists
        fi # end of if [ "x" != "x${num}" ] && [ "x" != "x${name}" ]; then
    done
fi
