#!/bin/sh

# exit if running already
THISSCRIPT=${0##*/}
if pgrep -lf ${THISSCRIPT} > /dev/null 2> /dev/null ; then
    exit 1
fi


. /usr/local/bin/loadmyvars.sh

if sysctl security.jail.jailed | grep 1 >/dev/null 2>&1; then
    echo "ERROR: Cannot run in a jail"
    exit 1
fi

if [ "x" = "x${FQDN}" ]; then
    echo "Please set or export variable FQDN"
    exit 1
fi

if [ "x" = "x${NIC}" ]; then
    NIC="lo1"
    if ! ifconfig ${NIC} >/dev/null ; then
        ifconfig ${NIC} create
    fi
fi

if [ "x" = "x${IPNET}" ]; then
    IPNET="10.7.7."
fi

if [ "x" = "x${HOSTNIC}" ]; then
    HOSTNIC="$( net-nic )"
fi

if [ "x" = "x${HOSTIP}" ]; then
    HOSTIP="$( net-ip $HOSTNIC )"
fi

if ! iocage list -r | grep 'RELEASE' >/dev/null 2>/dev/null ; then
    ioc-setup
    if ! iocage list -r | grep 'RELEASE' >/dev/null 2>/dev/null ; then
        echo "ERROR: iocage release doesn't exist, something went wrong."
        exit 1
    fi
fi

if [ "x" != "x${STARTCOUNT}" ]; then
    # remove anything that's not a digit
    count=`echo ${STARTCOUNT} | sed 's/[^[:digit:]]//g'`
fi

if [ "x" = "x${count}" ]; then
    count=0
fi


env IPNET="${IPNET}" HOSTIP="${HOSTIP}" HOSTNIC="${HOSTNIC}" _deploy_pf_ucarp


if ls /usr/local/etc/deployjails.conf.d/* >/dev/null 2>&1 ; then
    cat /usr/local/etc/deployjails.conf.d/* \
    | while read num name boot ; do
        case "$num" in "#"*|"") continue; esac
        if [ "x" != "x${num}" ] && [ "x" != "x${name}" ]; then
            if ! iocage get tag ${name} >/dev/null 2>/dev/null; then
                # The following case can be in any order
                case ${name} in
                    # GOOD JAILNAMES
                    nginx)                      _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    zfssyncstatus)              _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    ampache)                    _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    squid)                      _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    easydnsclient)              _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    couchdb)                    _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    dtfc|upload|transfer)       _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    mdwiki)                     _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    piwik)                      _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    ejabberd)                   _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    murmur)                     _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    vnc)                        _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    klaus)                      _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    keypkg)                     _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    smtp)                       _deploy_app ${IPNET}${num} ${name} ${boot} postfix ;;
                    mail)                       _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    owncloud)                   _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    gitlab)                     _deploy_app ${IPNET}${num} ${name} ${boot} ${name}_config ;;
                    builder|buildersquidpkg|builderffmpegpkg|buildergitlabpkg|builderbansheepkg|builderampachepkg|builderi2ppkg)
                                                _deploy_app ${IPNET}${num} ${name} ${boot}
                    ;;
                    # DEV JAILNAMES
                    monit)                      _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    zabbix)                     _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    echoplexus)                 _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    gitannex)                   _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    gogs)                       _deploy_app ${IPNET}${num} ${name} ${boot} ${name}_src ;;
                    phabricator)                _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    pydio)                      _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    # BAD JAILNAMES
                    baikal)                     _deploy_app ${IPNET}${num} ${name} ${boot} ;;
                    horde)                      _deploy_app ${IPNET}${num} ${name} ${boot} ${name}webmail ;;
                esac
                #if [ "xsquid" != "x${name}" ]; then
                #    iocage stop ${name}
                #fi
            fi # end of if not jail exists
        fi # end of if [ "x" != "x${num}" ] && [ "x" != "x${name}" ]; then
    done
fi
