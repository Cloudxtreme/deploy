#!/bin/sh

# READY

DB="owncloud"
DBUSER="owncloud"
DBPASS="password"

if [ "x" != "x${OWNCLOUDDBPASS}" ]; then
    DBPASS=${OWNCLOUDDBPASS}
fi

if sysctl -a | grep security.jail.sysvipc_allowed >/dev/null ; then
    if sysctl security.jail.sysvipc_allowed | grep 0 >/dev/null ; then
        echo "This jail is not configured to allow sysvipc."
        echo "you need to add jail_example_parameters=\"allow.sysvipc=1\""
        exit 1
    fi
fi

if [ "x" == "x${FQDN}" ]; then
    echo "Please set or export variable FQDN"
    exit 1
fi

pkg install -y owncloud \
lang/php56 \
php56-pdo_pgsql \
php56-pgsql \
postgresql93-server \
apache24


APPS="
    documents   https://apps.owncloud.com/CONTENT/content-files/168711-documents.zip
    bookmakrs   https://apps.owncloud.com/CONTENT/content-files/168710-bookmarks.zip
    contact     https://github.com/owncloud/contacts/releases/download/v8.0.5/contacts-0.3.0.19.tar.gz
    calendar    https://github.com/owncloud/calendar/releases/download/v0.6.5/calendar.zip
    rainloop    http://repository.rainloop.net/v2/other/owncloud/rainloop.zip
"

echo "${APPS}" \
| while read appname appurl ; do
    if [ "x" != "x${appname}" ] && [ "x" != "x${appurl}" ]; then
        if [ ! -e /root/local/owncloud/${appurl##*/} ]; then
            wget -P /root/local/owncloud "${appurl}"
        fi
        if [ ! -d /usr/local/www/owncloud/apps/${appname} ] ; then
            tar x -C /usr/local/www/owncloud/apps -f /root/local/owncloud/${appurl##*/}
        fi
    fi
done


# different uid so shared memory of postgresql don't clash
pw usermod -n pgsql -u 1060
find / -user 70 -exec chown pgsql {} \;

if [ ! -e /usr/local/bin/createuser ]; then
    echo "ERROR: install failed"
    exit 1
fi

apache-config-freebsd
pkg install -fy www/mod_php56
cat ~/git/deploy/usr/local/etc/apache24/extra/owncloud.conf \
| sed "s/localhost.my.domain/${FQDN}/" \
>/usr/local/etc/apache24/Includes/owncloud.conf

sysrc apache24_enable="YES"
#sysrc php_fpm_enable="YES"
sysrc postgresql_enable="YES"

#service php-fpm start
service apache24 start

service postgresql initdb
service postgresql start

/usr/local/bin/createuser -U pgsql ${DBUSER}
/usr/local/bin/createdb -E utf8 -U pgsql -O ${DBUSER} ${DB}
/usr/local/bin/psql -U pgsql -d template1 -c "ALTER ROLE ${DBUSER} WITH password '${DBPASS}';"

if [ ! -e /usr/local/pgsql/data/pg_hba.conf.dist ]; then
    cp -a /usr/local/pgsql/data/pg_hba.conf /usr/local/pgsql/data/pg_hba.conf.dist
fi

cat >/usr/local/pgsql/data/pg_hba.conf <<EOF
local   all             all                                     trust
host    all             all             127.0.0.1/32            trust
host    all             all             ::1/128                 trust
hostnossl  ${DB}   ${DBUSER}    samehost                trust
EOF

service postgresql restart

echo
echo "Visit https://${FQDN}/owncloud/"
echo "- setup Database to PostgreSQL with sql://${DBUSER}:${DBPASS}@localhost/${DB}"
echo "- install apps: Documents, Calendar, Contacts, Mail, Bookmarks"
#echo "- see share options on bottom left in Calendar/Contacts for iOS CalDav/CardDav URL"
