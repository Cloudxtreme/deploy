#!/bin/sh

# READY

if sysctl security.jail.jailed | grep 1 >/dev/null 2>&1; then
    echo "ERROR: Cannot run in a jail"
    exit 1
fi

. ~/bin/deploy_as_conf

JAILNAMES="${JAILSGOOD} ${JAILSBAD} ${JAILSDEV}"

eza stop

echo "$JAILNAMES" \
| while read num name ; do
    if [ "x" != "x${num}" ] && [ "x" != "x${name}" ]; then
        if [ "xsquid" != "x${name}" ]; then
            if zfs list -H tank/ezjail/${name} 2>/dev/null ; then
                eza delete ${name}
                zfs destroy -fr tank/ezjail/${name}
            fi
            if [ -d /usr/jails/${name} ]; then
                rmdir /usr/jails/${name}
            fi
        fi
    fi
done
