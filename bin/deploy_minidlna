#!/bin/sh

# READY

######################################################################
# Script version is yymmdd-HHMMSS in UTC, date -u +%y%m%d-%H%M%S
######################################################################
SCRIPTVERSION=150709-163724

BUILDIT="NO"

if sysctl security.jail.jailed | grep 1 >/dev/null 2>&1; then
    echo "ERROR: Multicast udp 1900 has issues reaching a jail"
    echo "ERROR: Clients will not detect this in a jail"
    exit 1
fi

if [ "xYES" == "x${BUILDIT}" ]; then
    NEWINSTALL="YES"
    if sysrc minidlna_enable | grep YES >/dev/null ; then
        NEWINSTALL="NO"
    fi
    if [ "xYES" == "x${NEWINSTALL}" ]; then
        if [ -e /var/ports/packages/All/minidlna-1.1.4_1,1.txz ]; then
            pkg add -f /var/ports/packages/All/minidlna-1.1.4_1,1.txz
        else
            # install squid and dependencies
            pkg install -y net/minidlna devel/autoconf devel/automake devel/gettext-tools converters/libiconv
            # remove squid because we want custom options
            # openssl from ports conflicts https://lists.freebsd.org/pipermail/freebsd-questions/2015-June/266245.html
            pkg remove -y net/minidlna
            # use portsnap, but portsnap doesn't like non-interactive so we need a human to help
            psnap

            if [ -d /usr/ports/net/minidlna ]; then
                cat > /tmp/patch-minissdp.c.b64 <<EOF
LS0tIG1pbmlzc2RwLmMub3JpZwkyMDE1LTA3LTA5IDAyOjI5OjU0LjYzMTk3NTc2
NCArMDAwMAorKysgbWluaXNzZHAuYwkyMDE1LTA3LTA5IDAyOjMxOjI5LjczNTM0
OTM5OCArMDAwMApAQCAtNjAsNyArNjAsNyBAQAogQWRkTXVsdGljYXN0TWVtYmVy
c2hpcChpbnQgcywgc3RydWN0IGxhbl9hZGRyX3MgKmlmYWNlKQogewogCWludCBy
ZXQ7Ci0jaWZkZWYgSEFWRV9TVFJVQ1RfSVBfTVJFUU4KKyNpZiBkZWZpbmVkKEhB
VkVfU1RSVUNUX0lQX01SRVFOKSAmJiAhZGVmaW5lZChfX0ZyZWVCU0RfXykKIAlz
dHJ1Y3QgaXBfbXJlcW4gaW1yOwkvKiBJcCBtdWx0aWNhc3QgbWVtYmVyc2hpcCAq
LwogCS8qIHNldHRpbmcgdXAgaW1yIHN0cnVjdHVyZSAqLwogCW1lbXNldCgmaW1y
LCAnXDAnLCBzaXplb2YoaW1yKSk7CkBAIC02MzUsNiArNjM1LDE3IEBACiAJCQkJ
CWJyZWFrOwogCQkJCX0KIAkJCX0KKwkJCS8vIGNoZWNrIGlmIHNlbmRlciBpcyBv
biBvdGhlciBpbnRlcmZhY2UgYW5kIGlmIHdlIGhhdmUgb25seSBvbmUgaW50ZXJm
YWNlCisJCQkvLyB0aGlzIHNpdHVhdGlvbiBtZWFucyB0aGF0IHdlIGhhdmUgY2xp
ZW50IGJlaGluZCBvdGhlciBzdWJuZXQKKwkJCS8vIGluIHRoYXQgY2FzZSByb3V0
ZXIgc2hvdWxkIGJlIGNhcGFibGUgb2YgaGFuZGxpbmcgUElNIHJvdXRpbmcKKwkJ
CWlmKCBpID09IG5fbGFuX2FkZHIgJiYgbl9sYW5fYWRkciA9PSAxKQorCQkJewor
CQkJCS8vIGZvcmNlIHVzaW5nIG9uZSBhbmQgb25seSBpbnRlcmZhY2UgZm9yIHJl
cXVlc3RzIGZyb20gb3RoZXIgbmV0d29yaworCQkJCWkgPSAwOworCQkJCS8vIGxl
dHMgcHJpbnQgb3V0IHNvbWUgZGVidWcgaW5mbworCQkJCURQUklOVEYoRV9ERUJV
RywgTF9TU0RQLCAiUmVjZWl2ZWQgU1NEUCBNLVNFQVJDSCBmcm9tIG90aGVyIHN1
Ym5ldCBbJXNdXG4iLAorCQkJCQlpbmV0X250b2Eoc2VuZGVybmFtZS5zaW5fYWRk
cikpOworCQkJfQogCQkJaWYgKG5fbGFuX2FkZHIgPT0gaSkKIAkJCXsKIAkJCQlE
UFJJTlRGKEVfREVCVUcsIExfU1NEUCwgIklnbm9yaW5nIFNTRFAgTS1TRUFSQ0gg
b24gb3RoZXIgaW50ZXJmYWNlIFslc11cbiIsCg==
EOF
                openssl enc -d -base64 -in /tmp/patch-minissdp.c.b64 > /usr/ports/net/minidlna/files/patch-minissdp.c
            fi
            cd /usr/ports/net/minidlna
            make && make install && make package && make clean
            # /var/ports/packages/All/minidlna-1.1.4_1,1.txz
        fi
        if ! which minidlnad ; then
            echo "Failed to build minidlna."
            exit 1
        fi
    fi
else
    pkg install -y net/minidlna
fi

if [ ! -e /usr/local/etc/minidlna.conf.sample ]; then
    echo "ERROR: install failed"
    exit 1
fi

zfs list tank/dlna || zfs create tank/dlna
if ! zfs list tank/dlna > /dev/null ; then
    echo "ERROR: missing tank/dlna"
    exit 1
fi

install -d -m 755 /tank/dlna/movies
install -d -m 755 /tank/dlna/music
install -d -m 755 /tank/dlna/photos

cat > /usr/local/etc/minidlna.conf <<EOF
port=8200
network_interface=lagg0
log_level=debug
media_dir=A,/tank/dlna/music
media_dir=V,/tank/dlna/movies
media_dir=P,/tank/dlna/photos
friendly_name=MEDIASERVER
album_art_names=Cover.jpg/cover.jpg/AlbumArtSmall.jpg/albumartsmall.jpg/AlbumArt.jpg/albumart.jpg/Album.jpg/album.jpg/Folder.jpg/folder.jpg/Thumb.jpg/thumb.jpg
inotify=yes
enable_tivo=no
strict_dlna=no
notify_interval=900
serial=12345678
model_number=1
EOF


crontabbed
if sysctl security.jail.jailed | grep 1 >/dev/null 2>&1; then
    echo > /root/crontabbed/zsnapple_bootpool_hourly
    echo > /root/crontabbed/zsnapple_pool_hourly
fi
echo "10 * * * * /usr/bin/find /tank/dlna -type d -exec chmod a+rx {} \;" > /root/crontabbed/permission_folders_hourly
echo "35 * * * * /usr/bin/find /tank/dlna -type f -exec chmod a+r {} \;" > /root/crontabbed/permission_files_hourly
crontabbed

# sysrc -f /etc/rc.conf.d/minidlna minidlna_enable="YES"

service minidlna onestart

echo
echo "Use a DLNA client to search for this machine"
