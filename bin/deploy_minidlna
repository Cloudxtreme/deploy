#!/bin/sh

# READY

######################################################################
# Script version is yymmdd-HHMMSS in UTC, date -u +%y%m%d-%H%M%S
######################################################################
SCRIPTVERSION=151008-041955

if sysctl security.jail.jailed | grep 1 >/dev/null 2>&1; then
    echo "ERROR: Multicast udp 1900 has issues reaching a jail"
    echo "ERROR: Clients will not detect this in a jail"
    exit 1
fi

pkg install -y net/minidlna

if [ ! -e /usr/local/etc/minidlna.conf.sample ]; then
    echo "ERROR: install failed"
    exit 1
fi

zfs list tank/data || zfs create tank/data
if ! zfs list tank/data > /dev/null ; then
    echo "ERROR: missing tank/data"
    exit 1
fi

install -d -m 755 /tank/data/movies
install -d -m 755 /tank/data/music
install -d -m 755 /tank/data/photos

install -m 644 /root/git/deploy/usr/local/etc/minidlna.conf /usr/local/etc/minidlna.conf


crontabbed
if sysctl security.jail.jailed | grep 1 >/dev/null 2>&1; then
    echo > /root/crontabbed/zsnapple_bootpool_hourly
    echo > /root/crontabbed/zsnapple_pool_hourly
fi
echo "10 * * * * dlna-permissions" > /root/crontabbed/dlna_permission_hourly
crontabbed

# sysrc -f /etc/rc.conf.d/minidlna minidlna_enable="YES"

service minidlna onestart

echo
echo "Use a DLNA client to search for this machine"
