#!/bin/sh

# TODO

DB="piwik"
DBUSER="piwik"
DBPASS="password"

if [ "x" != "x${PIWIKDBPASS}" ]; then
    DBPASS=${PIWIKDBPASS}
fi

if [ "x" == "x${FQDN}" ]; then
    echo "Please set or export variable FQDN"
    exit 1
fi

pkg install -y www/piwik \
php56-mbstring \
php56-simplexml \
php56-openssl \
percona55-server \
apache24

if [ ! -e /usr/local/www/piwik ]; then
    echo "ERROR: install failed"
    exit 1
fi

apache-config-freebsd
pkg install -fy www/mod_php56
cat ~/git/deploy/usr/local/etc/apache24/extra/piwik.conf \
| sed "s/localhost.my.domain/${FQDN}/" \
>/usr/local/etc/apache24/Includes/piwik.conf

# To pass the piwik system check
cat /usr/local/etc/php.ini-production | sed 's/;always_populate_raw_post_data = -1/always_populate_raw_post_data = -1/' >/usr/local/etc/php.ini
if [ ! -e /usr/local/www/piwik/misc/log-analytics/import_logs.py.orig ]; then
    cp -a /usr/local/www/piwik/misc/log-analytics/import_logs.py /usr/local/www/piwik/misc/log-analytics/import_logs.py.orig
fi
cat /usr/local/www/piwik/misc/log-analytics/import_logs.py.orig | sed 's;/usr/local/bin/python;/usr/bin/python;' >/usr/local/www/piwik/misc/log-analytics/import_logs.py
if [ ! -e /usr/bin/python ]; then
    ln -s /usr/local/bin/python /usr/bin/python
fi

sysrc apache24_enable="YES"
#sysrc php_fpm_enable="YES"
sysrc mysql_enable="YES"

#service php-fpm start
service apache24 start
service mysql-server start


while ! mysql -u root mysql -e "CREATE database ${DB};" 2>&1 | grep -o "database exists" ; do
    sleep 10
done

mysql -u root mysql -e "GRANT ALL PRIVILEGES ON ${DB} TO '${DBUSER}'@'localhost' IDENTIFIED BY '${DBPASS}';"
mysql -u root mysql -e "FLUSH PRIVILEGES;"
mysql -u root mysql -e "GRANT ALL PRIVILEGES ON ${DB}.* TO '${DBUSER}'@'localhost' IDENTIFIED BY '${DBPASS}' WITH GRANT OPTION;"
mysql -u root mysql -e "FLUSH PRIVILEGES;"

echo
JAILIP=`ifconfig | grep inet | awk '{print $2}'`
echo "Visit http://${JAILIP}/piwik/"
echo "- setup Database to MySQL with sql://${DBUSER}:${DBPASS}@localhost/${DB}"
