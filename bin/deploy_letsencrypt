#!/bin/sh

. /usr/local/bin/loadmyvars.sh

if [ "x" != "x$1" ]; then
    FQDN=$1
fi

if sysctl security.jail.jailed | grep 1 >/dev/null 2>&1; then
    echo "ERROR: Don't run this from a jail."
    exit 1
fi

LEUSER=_letsencrypt
LEGROUP=_letsencrypt
SSLPATH=/etc/ssl/letsencrypt
WEBROOT=/iocage/tags/nginx/root/usr/local/www/

CHALLENGE=/iocage/tags/nginx/root/usr/local/www/.well-known/acme-challenge

pkg install -y security/py-letsencrypt

if ! id ${LEUSER} >/dev/null 2>&1 ; then
    pw groupadd -n ${LEGROUP} -g 443
    pw useradd  -n ${LEUSER} -u 443 -g 443 -d ${SSLPATH} -w no -s /nonexistent
fi

zfs list tank/letsencrypt >/dev/null 2>&1 || zfs create -o mountpoint=${SSLPATH} tank/letsencrypt
chown root:${LEGROUP}  ${SSLPATH}
chmod 770              ${SSLPATH}

mkdir -p ${WEBROOT}

for i in ${WEBROOT}/.well-known \
        ${WEBROOT}/.well-known/acme-challenge ; do
    mkdir -p                   $i
    chown ${LEUSER}:${LEGROUP} $i
    chmod 755                  $i
done

if [ "x$REAL" != "x1" ]; then
    SERVER="--server https://acme-staging.api.letsencrypt.org/directory"
fi

su -m ${LEUSER} -c \
"letsencrypt certonly \
--email ${EMAIL} \
--agree-tos \
--config-dir ${SSLPATH}/config \
--work-dir ${SSLPATH}/work \
--logs-dir ${SSLPATH}/log \
${SERVER} \
--webroot \
-w ${WEBROOT} -d ${FQDN}"

NEWCRT=/etc/ssl/letsencrypt/config/live/${FQDN}/fullchain.pem
NEWKEY=/etc/ssl/letsencrypt/config/live/${FQDN}/privkey.pem
CRTPATH=/iocage/tags/nginx/root/usr/local/etc/nginx/ssl/${FQDN}.crt
KEYPATH=/iocage/tags/nginx/root/usr/local/etc/nginx/ssl/${FQDN}.key

if [ -e ${NEWCRT} ]; then
    install -C -m 644 ${NEWCRT}  ${CRTPATH}
fi
if [ -e ${NEWKEY} ]; then
    install -C -m 600 ${NEWKEY}  ${KEYPATH}
fi

cat <<EOF
If everything looks right, you can run:
    env REAL=1 ${0##*/} ${FQDN}
EOF
