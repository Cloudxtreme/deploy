#!/bin/sh

# READY
# Probably will not use because no web ui for calendar, shared calendars or busy lookups

if [ "x" == "x${FQDN}" ]; then
    echo "Please set or export variable FQDN"
    exit 1
fi

pkg install -y baikal \
lang/php56 \
nginx

if [ ! -e /usr/local/www/baikal/Specific ]; then
    echo "ERROR: install failed"
    exit 1
fi

nginx-config-sites-enabled
cat /root/git/deploy/usr/local/etc/nginx/sites-available/baikal \
| sed "s/localhost.my.domain/${FQDN}/" \
>/usr/local/etc/nginx/sites-enabled/baikal

touch /usr/local/www/baikal/Specific/ENABLE_INSTALL
chown -R www /usr/local/www/baikal/Specific

sysrc nginx_enable="YES"
sysrc php_fpm_enable="YES"

service php-fpm start
service nginx start

echo
echo "Visit https://${FQDN}/admin"
echo "Then:"
echo "rm /usr/local/www/baikal/Specific/ENABLE_INSTALL"
#echo "- on iOS add CalDav Calendar with server https://${FQDN}/principals/Administrator/"
