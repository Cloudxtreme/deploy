#!/bin/sh

# READY, helper to generate a deploy as_jails line

######################################################################
# Script version is yymmdd-HHMMSS in UTC, date -u +%y%m%d-%H%M%S
######################################################################
SCRIPTVERSION=150623-113222

OUTPUT="env"

while [ "x" == "x${FQDN}" ]; do
    echo -n "FQDN:"
    read FQDN
done
OUTPUT="${OUTPUT} FQDN=${FQDN}"


while [ "x" == "x${SQUID}" ]; do
    echo -n "SQUID [10.7.7.1:3128]:"
    read SQUID
    if [ "x" == "x${SQUID}" ]; then
        SQUID="10.7.7.1:3128"
    fi
done
OUTPUT="${OUTPUT} SQUID=${SQUID}"


while [ "x" == "x${REPOSRC}" ]; do
    echo -n "REPOSRC [https://github.com/]:"
    read REPOSRC
    if [ "x" == "x${REPOSRC}" ]; then
        REPOSRC=https://github.com/
    fi
done
OUTPUT="${OUTPUT} REPOSRC=${REPOSRC}"


while [ "x" == "x${GITLABSRC}" ]; do
    echo -n "GITLABSRC [https://gitlab.com/]:"
    read GITLABSRC
    if [ "x" == "x${GITLABSRC}" ]; then
        GITLABSRC=https://gitlab.com/
    fi
done
OUTPUT="${OUTPUT} GITLABSRC=${GITLABSRC}"


while [ "x" == "x${NIC}" ]; do
    echo -n "NIC [lo1]:"
    read NIC
    if [ "x" == "x${NIC}" ]; then
        NIC="lo1"
    fi
done
OUTPUT="${OUTPUT} NIC=${NIC}"
if ! ifconfig ${NIC} >/dev/null ; then
    ifconfig ${NIC} create
fi


while [ "x" == "x${IPNET}" ]; do
    echo -n "IPNET [10.7.7.]:"
    read IPNET
    if [ "x" == "x${IPNET}" ]; then
        IPNET="10.7.7."
    fi
done
OUTPUT="${OUTPUT} IPNET=${IPNET}"


while [ "x" == "x${HOSTIP}" ]; do
    IP=`ifconfig | grep -v 0xffffffff | grep -v 127.0.0.1 | egrep -o 'inet *([0-9]{1,3}\.){1,3}[0-9]{1,3}' | awk '{print $2}'`
    echo -n "HOSTIP [${IP}]:"
    read HOSTIP
    if [ "x" == "x${HOSTIP}" ]; then
        HOSTIP="${IP}"
    fi
done
OUTPUT="${OUTPUT} HOSTIP=${HOSTIP}"


while [ "x" == "x${HOSTNIC}" ]; do
    REALNIC=`netstat -nr | grep default | awk '{print $NF}'`
    echo -n "REALNIC [${REALNIC}]:"
    read HOSTNIC
    if [ "x" == "x${HOSTNIC}" ]; then
        HOSTNIC="${REALNIC}"
    fi
done
OUTPUT="${OUTPUT} HOSTNIC=${HOSTNIC}"


if [ "x" == "x${SQUIDIPALIAS}" ]; then
    echo -n "SQUIDIPALIAS:"
    read SQUIDIPALIAS
    if [ "x" != "x${SQUIDIPALIAS}" ]; then
        OUTPUT="${OUTPUT} SQUIDIPALIAS=${SQUIDIPALIAS}"
    fi
fi


while [ "x" == "x${OWNCLOUDDBPASS}" ]; do
    echo -n "OWNCLOUDDBPASS [password]:"
    read OWNCLOUDDBPASS
    if [ "x" == "x${OWNCLOUDDBPASS}" ]; then
        OWNCLOUDDBPASS="password"
    fi
done
OUTPUT="${OUTPUT} OWNCLOUDDBPASS=${OWNCLOUDDBPASS}"


while [ "x" == "x${GITLABROOTPASS}" ]; do
    echo -n "GITLABROOTPASS [password]:"
    read GITLABROOTPASS
    if [ "x" == "x${GITLABROOTPASS}" ]; then
        GITLABROOTPASS="password"
    fi
done
OUTPUT="${OUTPUT} GITLABROOTPASS=${GITLABROOTPASS}"


while [ "x" == "x${GITLABDBPASS}" ]; do
    echo -n "GITLABDBPASS [password]:"
    read GITLABDBPASS
    if [ "x" == "x${GITLABDBPASS}" ]; then
        GITLABDBPASS="password"
    fi
done
OUTPUT="${OUTPUT} GITLABDBPASS=${GITLABDBPASS}"


while [ "x" == "x${EJABBERDROOTPASS}" ]; do
    echo -n "EJABBERDROOTPASS [password]:"
    read EJABBERDROOTPASS
    if [ "x" == "x${EJABBERDROOTPASS}" ]; then
        EJABBERDROOTPASS="password"
    fi
done
OUTPUT="${OUTPUT} EJABBERDROOTPASS=${EJABBERDROOTPASS}"


OUTFILE="/root/local/deploy_helper"
mkdir -p ${OUTFILE%/*}
echo "${OUTPUT} deploy as_jails good" >>${OUTFILE}

cat <<EOF
You can edit then run:
    sh ${OUTFILE}
EOF
