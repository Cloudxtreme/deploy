#!/bin/sh

# READY

######################################################################
# Script version is yymmdd-HHMMSS in UTC, date -u +%y%m%d-%H%M%S
######################################################################
SCRIPTVERSION=150709-032330

if sysctl security.jail.jailed | grep 1 >/dev/null 2>&1; then
    echo "ERROR: Cannot run in a jail"
    exit 1
fi

. ~/bin/deploy_conf_jails

JAILNAMES="${GOOD} ${BAD} ${DEV}"

eza stop

echo "$JAILNAMES" \
| while read num name ; do
    if [ "x" != "x${num}" ] && [ "x" != "x${name}" ]; then
        if [ "xsquid" != "x${name}" ]; then
            if zfs list -H tank/ezjail/${name} 2>/dev/null ; then
                eza delete ${name}
                zfs destroy -fr tank/ezjail/${name}
            fi
            if [ -d /usr/jails/${name} ]; then
                rmdir /usr/jails/${name}
            fi
        fi
    fi
done
