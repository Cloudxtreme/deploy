#!/bin/sh

# TODO

######################################################################
# Script version is yymmdd-HHMMSS in UTC, date -u +%y%m%d-%H%M%S
######################################################################
SCRIPTVERSION=151009-115713

if [ "x" == "x${FQDN}" ]; then
    echo "Please set or export variable FQDN"
    exit 1
fi
JAILIP=`ifconfig | grep inet | awk '{print $2}'`

pkg install -y py27-pip sudo nginx

# install the gitosis app and user
pkg install -y py27-gitosis
# remove the gitosis app, but keep the user
pkg remove -y py27-gitosis

pip install waitress klaus markdown watchdog

mkdir -p /var/run/klaus && chown www:www /var/run/klaus

cat /root/git/deploy/usr/local/etc/nginx/sites-available/klaus \
| sed "s/127.0.0.1/${JAILIP}/" \
| sed "s/localhost.localdomain/${FQDN}/" \
>/usr/local/etc/nginx/sites-enabled/klaus
chmod 644 /usr/local/etc/nginx/sites-enabled/klaus
sysrc nginx_enable="YES"
service nginx start

cat /root/git/deploy/usr/local/lib/python2.7/site-packages/klauswsgireload.py \
| sed "s/0.0.0.0/${JAILIP}/" \
| sed "s;unrelenting.technology;${FQDN};" \
| sed "s;/home/freebsd/src/github.com/myfreeweb;/usr/local/git;" \
>/usr/local/lib/python2.7/site-packages/klauswsgireload.py

install -m 755 /root/git/deploy/usr/local/etc/rc.d/klaus /usr/local/etc/rc.d/klaus

if sysctl security.jail.jailed | grep 1 >/dev/null ; then
    cat /etc/ssh/sshd_config \
    | sed 's/#Port 22/Port 23/' \
    >/etc/ssh/sshd_config.tmp
    cat /etc/ssh/sshd_config.tmp >/etc/ssh/sshd_config
    rm /etc/ssh/sshd_config.tmp
fi
sysrc sshd_enable="YES"
sysrc sshd_rsa1_enable="NO"
sysrc sshd_dsa_enable="NO"
sysrc sshd_ecdsa_enable="NO"
service sshd start
