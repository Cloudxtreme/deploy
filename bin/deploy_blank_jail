#!/bin/sh

# READY

######################################################################
# Script version is yymmdd-HHMMSS in UTC, date -u +%y%m%d-%H%M%S
######################################################################
SCRIPTVERSION=150724-233035

# Usage: env SQUID=10.7.7.1:3128 $0 name "lo1|10.7.7.253"

name="$1"
nicip="$2"

if [ "x" == "x${name}" ]; then
    echo "ERROR: name not specified"
    exit 1
fi

if [ "x" == "x${nicip}" ]; then
    echo "ERROR: nicip not specified"
    exit 1
fi

if sysctl security.jail.jailed | grep 1 >/dev/null 2>&1; then
    echo "ERROR: Cannot run in a jail"
    exit 1
fi

if [ "x" == "x${REPOSRC}" ]; then
    REPOSRC=https://github.com/
fi

if [ "x" == "x${GITLABSRC}" ]; then
    GITLABSRC=https://gitlab.com/
fi

if ! zfs list tank >/dev/null ; then
    fzg -i -D
fi

if ! zfs list tank/ezjail >/dev/null ; then
    eza install -h file:///boot/../10.1-RELEASE
    eza-update
fi

copysslselfcert() {
    if [ -e /usr/jails/squid/usr/local/etc/squid/public.pem ]; then
        cat /usr/jails/squid/usr/local/etc/squid/public.pem >>/usr/jails/${1}/usr/local/share/certs/ca-root-nss.crt
    fi
}

if [ ! -e /usr/jails/${name} ]; then
    echo "Creating: ${name}  ${nicip}"
    eza create      ${name} "${nicip}"
    if [ "x" != "x${HTTP_PROXY}" ]; then
        SQUID=`echo ${HTTP_PROXY} | sed 's;http://;;'`
        echo SQUID=${SQUID}
        env SQUID=${SQUID} REPOSRC=${REPOSRC} eza-unlink-basejail ${name}
    else
        env REPOSRC=${REPOSRC} eza-unlink-basejail ${name}
    fi
    eza stop ${name}
    zfs snap tank/ezjail/${name}@created
    copysslselfcert ${name}
else
    echo "ERROR: jail exists"
    exit 1
fi
