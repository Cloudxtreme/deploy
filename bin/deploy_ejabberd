#!/bin/sh

# READY

######################################################################
# Script version is yymmdd-HHMMSS in UTC, date -u +%y%m%d-%H%M%S
######################################################################
SCRIPTVERSION=150608-064805

pkg install -y net-im/ejabberd

if [ ! -f /usr/local/etc/ejabberd/ejabberd.yml ]; then
    if [ -f /usr/local/etc/ejabberd/ejabberd.yml.example ]; then

        nginx-config-sites-enabled
        SSLPEM=/usr/local/etc/ejabberd/ssl.pem
        touch ${SSLPEM}
        chown ejabberd ${SSLPEM}
        chmod 600 ${SSLPEM}
        cat /usr/local/etc/nginx/ssl/ssl.crt /usr/local/etc/nginx/ssl/ssl.key >${SSLPEM}

        EJYML=/usr/local/etc/ejabberd/ejabberd.yml
        touch ${EJYML}
        chown ejabberd ${EJYML}
        chmod 600 ${EJYML}

        cat /usr/local/etc/ejabberd/ejabberd.yml.example \
            | sed 's/## certfile: "\/path\/to\/ssl.pem"/certfile: "\/usr\/local\/etc\/ejabberd\/ssl.pem"/' \
            | sed 's/## starttls_required: true/starttls_required: true/' \
            | sed "s/## admin:/admin:<    user:<      - \"admin\": \"localhost\"/" \
            | tr '<' '\n' \
            >${EJYML}
    fi
fi

sysrc ejabberd_enable="YES"

service ejabberd start

count=0
while ! service ejabberd status ; do
    count=$(( count + 1 ))
    sleep 2
    if [ ${count} -gt 10 ]; then
        echo "ERROR: failed to start ejabberd."
        exit 1
    fi
done

EJABBERDCTL=/usr/local/sbin/ejabberdctl
EJABBERDUSER=ejabberd

su $EJABBERDUSER -c "$EJABBERDCTL register admin localhost password"
