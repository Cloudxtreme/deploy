#!/bin/sh

# READY

######################################################################
# Script version is yymmdd-HHMMSS in UTC, date -u +%y%m%d-%H%M%S
######################################################################
SCRIPTVERSION=150618-013505

ROOTUSER="root"
ROOTPASS="password"

pkg install -y net-im/ejabberd

if [ ! -e /usr/local/etc/ejabberd/ejabberd.yml.example ]; then
    echo "ERROR: install failed"
    exit 1
fi


if [ ! -f /usr/local/etc/ejabberd/ejabberd.yml ]; then
    if [ -f /usr/local/etc/ejabberd/ejabberd.yml.example ]; then

        nginx-config-sites-enabled
        SSLPEM=/usr/local/etc/ejabberd/ssl.pem
        touch ${SSLPEM}
        chown ejabberd ${SSLPEM}
        chmod 600 ${SSLPEM}
        cat /usr/local/etc/nginx/ssl/ssl.crt /usr/local/etc/nginx/ssl/ssl.key >${SSLPEM}

        EJYML=/usr/local/etc/ejabberd/ejabberd.yml
        touch ${EJYML}
        chown ejabberd ${EJYML}
        chmod 600 ${EJYML}

        cat /usr/local/etc/ejabberd/ejabberd.yml.example \
            | sed 's/## certfile: "\/path\/to\/ssl.pem"/certfile: "\/usr\/local\/etc\/ejabberd\/ssl.pem"/' \
            | sed 's/## starttls_required: true/starttls_required: true/' \
            | sed "s/## admin:/admin:<    user:<      - \"admin\": \"localhost\"/" \
            | tr '<' '\n' \
            >${EJYML}
    fi
fi

sysrc ejabberd_enable="YES"

service ejabberd start

count=0
while ! service ejabberd status ; do
    count=$(( count + 1 ))
    sleep 2
    if [ ${count} -gt 10 ]; then
        echo "ERROR: failed to start ejabberd."
        exit 1
    fi
done

EJABBERDCTL=/usr/local/sbin/ejabberdctl
EJABBERDUSER=ejabberd

su $EJABBERDUSER -c "$EJABBERDCTL register ${ROOTUSER} localhost ${ROOTPASS}"

echo
JAILIP=`ifconfig | grep inet | awk '{print $2}'`
echo "Visit http://${JAILIP}:5280/admin/"
echo "Login as ${ROOTUSER}@localhost:${ROOTPASS}"
echo "Connect XMPP clients to ${JAILIP}:5222"
